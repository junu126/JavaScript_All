# 최소화와 압축
파일 유효성 검사를 마친 후 파일을 합치고 구웠으면 이제 용량을 줄일 수 있는 만큼 줄여야 합니다. 이 단계에서는 파일 최소화와 압축이라는 두 가지 절차를 거치게 됩니다. 최소화는 파일에서 필요 없는 공백과 주석을 지우고 그 외 여러 처리를 통해 파일을 가능한 작게 만드는 작업입니다. 압축은 gzip 같은 압축 방법을 사용해 최소화한 파일의 크기를 더 줄입니다. 여기서 최소화한 파일은 단순한 텍스트 파일이어서 최소화하기 전처럼 수정할 수도 있고 바로 웹 페이지에서 불러다 쓸 수 있지만 압축된 파일은 읽을 수도 없고 웹 페이지에서 반드시 압축을 해제한 후에 사용해야 한다는 점이 다릅니다. 2012년에는 브라우저에서 압축된 어떤 파일이든 응답 헤더가 'Content-Encoding:gzip'이면 자동으로 압축을 해제할 수 있습니다.

## 8.1 최소화
자바스크립트 파일 최소화는 그리 복잡하지 않지만 처리 과정이 안전하지 않으면 오류나 문법상에 문제가 발생할 수도 있습니다. 따라서 최소화하기 전에 파서로 자바스크립트 코드의 구문을 먼저 분석하는 최소화 툴을 사용하는 게 좋습니다. 파서는 유효한 문법이 무엇인지 알고 있기 때문에 최소화 후에도 유효한 문법의 코드를 쉽게 만들 수 있습니다. 다음 세 가지 최소화 툴이 가장 일반적 입니다.

- **YUI Compressor**  
'줄리앙 르꽁뜨'가 만들었으며 주석과 필요없는 공백을 제거할 뿐 만아니라 용량을 더 줄이기 위해 지역 변수를 한 글자나 두 글자로 변경하기도 합니다. 하지만 YUI Compressor는 최소화 후에 문법이나 실행 시간에 문제가 없는 것을 최우선 순위로 두고 있어 에러가 발생하기 쉬운 구문에서는 변수명을 변경하지 않습니다.

- **Closure Compiler**  
YUI Compressor의 기능을 할 뿐만 아니라 코드에 최적화 작업도 수행합니다. 예를 들면 사용하지 않는 함수가 있으면 그 함수를 제거하고, 단 한번만 쓰이는 함수라면 인라인 함수로 변경합니다.

- **UgifyJS**  
UglifyJS는 Nods.js로 만든 최초의 자바스크립트 최소화 툴 입니다. '미하이 바존'이 개발 했으며, YUI Compressor의 기능을 함과 동시에 여러개의 var문을 하나로 묶는 등의 최적화를 진행합니다.

툴을 선택하는 것은 여러분의 몫입니다. 어떤 사람은 이것을 다른 사람은 저것을 선호하는 것 처럼 사용해보시고 원하는 툴을 선택하시면 됩니다.

## 8.2 압축
자바스크립트 최소화는 배포 전 첫 번째 단계입니다. 그 다음 단계는 파일을 전송할 때 용량을 가능한 작게 압축하는 것 입니다. 최소화 툴은 자바스크립트를 압축하지 않고 최소화 작업만 수행합니다. 이는 언뜻 이름만 봐서는 압축도 할 것 같은 YUI Compressor도 마찬가지 입니다. 압축 처리는 파일 처리에서 가장 마지막에 하게 되는데 보통 HTTP 압축을 통해 실시간으로 빌드할 때 합니다.

### 8.2.1 실시간 압축
대부분의 웹 서버는 파일을 실시간으로 압축할 수 있습니다. 실제로 실시간 압축은 보통 자바스크립트, HTML, CSs와 같은 텍스트 파일만 압축합니다. 모든 최신 웹 브라우저는 HTTP 압축을 지원하며 서버에 HTTP 요청을 보낼 때 압축을 처리할 수 있다는 의미에서 다음과 같은 HTTP 헤더를 서버에 보냅니다.
```javascript
Accept-Encoding : gzip, deflate
```
요청에 이런 HTTP 헤더가 있으면 웹 서버는 이 요청을 보낸 웹 브라우저가 gzip 또는 deflate으로 압축된 파일을 해제할 수 있음을 알게 됩니다. 그러면 서버는 응답을 보낼 때 헤더에 다음과 같이 압축 형식이 무엇인지 알려줍니다.

```javascript
Content-Encoding : gzip
```
여기서 헤더는 서버가 보낸 body의 내용이 gzip으로 압축되었으니 사용하기 전에 반드시 브라우저에서 압축 해제해서 사용해야 한다고 알려주는 역할을 합니다.

### 8.2.2 빌드 시간 압축
원한다면 서버에 간섭 받지 않고 빌드 시간에 파일을 압축하여 배포할 수도 있습니다. 대표적으로 jQuery는 gzip으로 압축한 메인 자바스크립트 파일을 http://jquery.com을 통해 사용자에게 배포하고 있습니다. gzip 압축은 빌드 시간에 애느의 gzip 태스크를 이용하면 아주 간단하게 파일을 압축할 수 있습니다.

최적화와 압축을 통해 빌드시간을 단축하고, 용량을 줄이는 등의 여러 보수과정을 거칠 수 있습니다.